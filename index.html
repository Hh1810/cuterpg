<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å­¸ç¿’å°ç²¾éˆ â€” ç¶ è‰²ç‰ˆ RPGï¼ˆå¯ç›´æ¥åŸ·è¡Œï¼‰</title>
  <style>
    /* ç¶ è‰²ä¸»é¡Œã€ç°¡æ½”å®‰å…¨ç‰ˆ */
    :root{
      --bg:#eeffef;
      --panel:#f6fff8;
      --accent:#3aa45e;
      --muted:#5b6b5a;
      --soft:#dff7e6;
      --shadow: 0 8px 20px rgba(58,164,94,0.10);
      font-family: 'Noto Sans TC', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#133; -webkit-font-smoothing:antialiased}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:linear-gradient(90deg,#dff7e6,#eefff0);box-shadow:var(--shadow)}
    .logo{font-weight:700;font-size:18px;color:var(--accent)}
    .app{max-width:1000px;margin:18px auto;border-radius:12px;overflow:hidden;padding:12px}
    .main{display:flex;gap:16px;padding:6px}
    .sidebar{width:260px}
    .content{flex:1;display:flex;flex-direction:column;gap:12px}
    .panel{background:var(--panel);padding:12px;border-radius:12px;box-shadow:var(--shadow)}
    .avatar{font-size:44px;background:linear-gradient(90deg,#f0fff3,#e8fff0);width:76px;height:76px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 12px rgba(0,0,0,0.04)}
    .xpbar{width:80%;height:12px;background:#eef6ee;border-radius:999px;margin-top:8px;overflow:hidden}
    #xpFill{height:100%;width:24%;background:linear-gradient(90deg,var(--accent),#7bdc93)}
    .badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .badge{background:var(--soft);padding:6px 8px;border-radius:999px;font-size:12px;color:#084a20}
    .quests-preview{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .quest-card{padding:10px;border-radius:10px;background:linear-gradient(180deg,#ffffff,#f7fff9);border:1px dashed #dff4dd}
    .quest-type{font-weight:700;color:var(--accent)}
    button{background:var(--accent);color:#fff;padding:8px 12px;border-radius:10px;border:none;cursor:pointer}
    button.small{padding:6px 8px;font-size:13px}
    button.secondary{background:#fff;color:var(--accent);border:1px solid rgba(0,0,0,0.06)}
    label{display:block;margin:6px 0}
    textarea{min-height:100px;width:100%;padding:8px;border-radius:8px;border:1px solid #e6f3e8}
    input[type="text"]{width:100%;padding:8px;border-radius:8px;border:1px solid #e6f3e8}
    .muted{color:var(--muted);font-size:13px;margin-top:6px}
    .footer{text-align:center;padding:10px;color:var(--muted);font-size:13px;margin-top:8px}
    a.small-link{color:var(--accent);font-size:13px;text-decoration:none}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="logo">ğŸŒ¿ å­¸ç¿’å°ç²¾éˆï¼ˆç¶ ï¼‰</div>
    <div>
      <button id="deployHint" class="small secondary">éƒ¨ç½² & å®‰å…¨èªªæ˜</button>
    </div>
  </div>

  <div class="app">
    <div class="main">
      <aside class="sidebar">
        <div class="panel" style="text-align:center">
          <div class="avatar">ğŸ¦‹</div>
          <h3 id="playerName">å†’éšªè€…</h3>
          <div>Lv <strong id="level">1</strong></div>
          <div class="xpbar"><div id="xpFill"></div></div>
        </div>

        <div class="panel">
          <h4>å¾½ç« </h4>
          <div id="badges" class="badges"></div>
        </div>
      </aside>

      <section class="content">
        <div class="panel">
          <h3>ä»Šæ—¥ä»»å‹™</h3>
          <p class="muted">å®Œæˆä»»å‹™å¯ç²å¾— XPã€å¾½ç« èˆ‡ç¨±è™Ÿã€‚</p>

          <div id="questsPreview" class="quests-preview"></div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="startBtn">é–‹å§‹ä»»å‹™ï¼ˆå…ˆç”¨ mock / é›¢ç·šï¼‰</button>
            <button id="fetchGeminiBtn" class="secondary">ç”¨ Gemini ç”¢ç”Ÿï¼ˆéœ€è¦é‡‘é‘°ï¼‰</button>
          </div>
        </div>

        <div class="panel" id="questPanel" style="display:none">
          <button id="backBtn" class="secondary small">â† è¿”å›</button>
          <h3 id="questTitle">ä»»å‹™</h3>
          <div id="questArea"></div>
          <div style="margin-top:10px;text-align:right">
            <button id="submitBtn">æäº¤ç­”æ¡ˆ</button>
          </div>
        </div>

        <div class="panel">
          <h4>è¨­å®šï¼ˆå¦‚æœä½ è¦æ¥ Geminiï¼Œè¤‡è£½ config.example.js ç‚º config.jsï¼‰</h4>
          <p class="muted">ä¸æƒ³è™•ç† keyï¼ŸæŒ‰ <a id="proxyOffer" class="small-link">æˆ‘è¦ proxyï¼ˆå®‰å…¨ï¼‰</a>ï¼Œæˆ‘æœƒçµ¦ä½ æ­¥é©Ÿã€‚</p>
          <pre style="background:#f0fff6;padding:8px;border-radius:6px">/* config.example.js */
const GEMINI_API_KEY = 'AIzaSyA1qz0SSfgtykSctZ35rhLI1IesiSxN4UQ'; // ä¸è¦æ”¾åˆ°å…¬é–‹ repo!
const GEMINI_MODEL = 'models/gemini-1.5-pro';
const GEMINI_ENDPOINT_BASE = 'https://generativelanguage.googleapis.com/v1beta2';
</pre>
        </div>
      </section>
    </div>

    <div class="footer">Â© å­¸ç¿’å°ç²¾éˆ â€” æœ¬åœ°å¯åŸ·è¡Œ Demoï¼ˆç¶ ï¼‰</div>
  </div>

  <script>
  /****************************************************************
   * ç«‹å³å¯é‹è¡Œçš„å–®æª”ç‰ˆ (ä¸éœ€å¾Œç«¯)
   * - è‹¥æ²’æœ‰ config.js æˆ–æ²’æœ‰é‡‘é‘°ï¼Œæœƒè‡ªå‹•ä½¿ç”¨ mock é¡Œç›®ï¼ˆå¯é›¢ç·šé‹è¡Œï¼‰
   * - è‹¥ä½ æ”¾ç½® config.js ä¸¦åœ¨è£¡é¢è¨­å®š GEMINI_API_KEYï¼ŒæŒ‰ã€Œç”¨ Gemini ç”¢ç”Ÿã€æœƒå˜—è©¦å‘¼å« Gemini REST
   * - è‹¥ä½ è¦å…¬é–‹éƒ¨ç½²ï¼ˆGitHub Pagesï¼‰ï¼Œè«‹ä¸è¦æŠŠ config.jsï¼ˆå« KEYï¼‰æ”¾åˆ°å…¬é–‹ repo
   ****************************************************************/

  // å®‰å…¨ï¼šå˜—è©¦è¼‰å…¥ config.jsï¼ˆå¦‚æœä½¿ç”¨è€…å·²æ”¾ï¼‰
  let GEMINI_API_KEY = null;
  let GEMINI_MODEL = null;
  let GEMINI_ENDPOINT_BASE = null;
  try {
    // window.config.js should set GEMINI_API_KEY, GEMINI_MODEL, GEMINI_ENDPOINT_BASE
    if (window.GEMINI_API_KEY) GEMINI_API_KEY = window.GEMINI_API_KEY;
    if (window.GEMINI_MODEL) GEMINI_MODEL = window.GEMINI_MODEL;
    if (window.GEMINI_ENDPOINT_BASE) GEMINI_ENDPOINT_BASE = window.GEMINI_ENDPOINT_BASE;
  } catch(e){/* ignore */}

  // App state
  const state = { xp: 20, level: 1, badges: [] };
  let quests = [];
  let currentIndex = 0;

  // DOM
  const questsPreviewEl = document.getElementById('questsPreview');
  const startBtn = document.getElementById('startBtn');
  const fetchGeminiBtn = document.getElementById('fetchGeminiBtn');
  const questPanel = document.getElementById('questPanel');
  const questArea = document.getElementById('questArea');
  const questTitle = document.getElementById('questTitle');
  const backBtn = document.getElementById('backBtn');
  const submitBtn = document.getElementById('submitBtn');
  const badgesEl = document.getElementById('badges');
  const xpFill = document.getElementById('xpFill');
  const levelEl = document.getElementById('level');
  const deployHint = document.getElementById('deployHint');
  const proxyOffer = document.getElementById('proxyOffer');

  function renderProfile(){
    xpFill.style.width = Math.min(100, (state.xp % 100)) + '%';
    levelEl.textContent = state.level;
    badgesEl.innerHTML = '';
    state.badges.forEach(b => {
      const d = document.createElement('div'); d.className='badge'; d.textContent = b; badgesEl.appendChild(d);
    });
  }

  function mockGenerateQuests(){
    return [
      { type:'è‹±æ–‡', payload:{ question:'Which word means \"å‹å–„\"?', choices:['hostile','kind','sad','tall'], answer:1 }},
      { type:'ç¨‹å¼', payload:{ question:'What does console.log do in JS?', choices:['show value','delete file','create var','none'], answer:0 }},
      { type:'AI', payload:{ question:'Write one short tip to remember new words.' } }
    ];
  }

  function renderQuestsPreview(){
    questsPreviewEl.innerHTML = '';
    quests.forEach((q,i) => {
      const card = document.createElement('div'); card.className='quest-card';
      card.innerHTML = `<div class="quest-type">${q.type}</div><div class="quest-short">${q.payload.question}</div>`;
      questsPreviewEl.appendChild(card);
    });
  }

  startBtn.addEventListener('click', ()=> {
    // Local mock version: immediate and works offline
    quests = mockGenerateQuests();
    renderQuestsPreview();
    showQuest(0);
  });

  backBtn.addEventListener('click', ()=> {
    questPanel.style.display = 'none';
  });

  function showQuest(idx){
    currentIndex = idx;
    const q = quests[idx];
    if(!q) return;
    questTitle.textContent = `${q.type} ä»»å‹™`;
    questPanel.style.display = 'block';
    renderQuest(q);
  }

  function renderQuest(q){
    questArea.innerHTML = '';
    const p = document.createElement('p'); p.textContent = q.payload.question; questArea.appendChild(p);
    if(Array.isArray(q.payload.choices) && q.payload.choices.length){
      q.payload.choices.forEach((c,i)=>{
        const label = document.createElement('label');
        const r = document.createElement('input'); r.type='radio'; r.name='choice'; r.value=i;
        label.appendChild(r); label.append(' ' + c); questArea.appendChild(label);
      });
    } else {
      const ta = document.createElement('textarea'); ta.placeholder='åœ¨æ­¤è¼¸å…¥ç­”æ¡ˆ...'; questArea.appendChild(ta);
    }
  }

  submitBtn.addEventListener('click', ()=> {
    const q = quests[currentIndex];
    const sel = document.querySelector('input[name="choice"]:checked');
    let correct = false;
    if(sel && q.payload.answer != null) correct = String(sel.value) === String(q.payload.answer);
    else correct = true; // free text - give partial credit

    const xpGain = correct ? 40 : 10;
    state.xp = (state.xp || 0) + xpGain;
    if(state.xp >= 200){
      state.level += 1;
      state.xp = state.xp - 200;
      if(!state.badges.includes('å‡ç´šå‹‡è€…')) state.badges.push('å‡ç´šå‹‡è€…');
    }
    if(!state.badges.includes('ä»»å‹™é”æˆ')) state.badges.push('ä»»å‹™é”æˆ');

    alert('ä»»å‹™å®Œæˆï¼ç²å¾— XP: ' + xpGain);
    renderProfile();

    if(currentIndex < quests.length - 1) showQuest(currentIndex+1);
    else questPanel.style.display = 'none';
  });

  // Gemini button (optional) - will attempt REST call only if GEMINI_API_KEY present in config.js
  fetchGeminiBtn.addEventListener('click', async ()=>{
    if(!GEMINI_API_KEY){
      alert('æ‰¾ä¸åˆ° Gemini é‡‘é‘°ï¼Œç³»çµ±æœƒå…ˆä½¿ç”¨æœ¬æ©Ÿé›¢ç·šé¡Œç›®ã€‚è‹¥è¦ä½¿ç”¨ Geminiï¼Œè«‹å»ºç«‹ config.js ä¸¦æŠŠ GEMINI_API_KEY æ”¾å…¥ã€‚');
      quests = mockGenerateQuests();
      renderQuestsPreview();
      showQuest(0);
      return;
    }
    try {
      quests = await fetchQuestsFromGemini();
      renderQuestsPreview();
      showQuest(0);
    } catch(err){
      console.error(err);
      alert('å‘¼å« Gemini ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message + '\\nç³»çµ±æ”¹ç‚ºä½¿ç”¨æœ¬æ©Ÿé¡Œç›®ã€‚');
      quests = mockGenerateQuests();
      renderQuestsPreview();
      showQuest(0);
    }
  });

  // function to call Gemini REST (best-effort; may be blocked by CORS depending on environment)
  async function fetchQuestsFromGemini(){
    const prompts = [
      {type:'è‹±æ–‡', prompt:'Generate a beginner English multiple choice question (4 choices) about vocabulary. Respond JSON only: {\"question\":..., \"choices\":[...], \"answer\":index}'},
      {type:'ç¨‹å¼', prompt:'Generate a beginner JavaScript multiple choice question (4 choices). Respond JSON only.'},
      {type:'AI', prompt:'Generate a single-sentence study tip and return as JSON {\"question\":\"...\"}.'}
    ];
    const out = [];
    for(const p of prompts){
      const text = await callGemini(p.prompt);
      try {
        const parsed = JSON.parse(text);
        out.push({ type: p.type, payload: parsed });
      } catch(e){
        out.push({ type: p.type, payload: { question: text, choices:[], answer:null }});
      }
    }
    return out;
  }

  async function callGemini(prompt){
    // Build endpoint (this uses the legacy simple REST pattern with key param â€” may require proper Google Cloud setup)
    const url = (GEMINI_ENDPOINT_BASE || 'https://generativelanguage.googleapis.com/v1beta2') + '/' + (GEMINI_MODEL || 'models/gemini-1.5-pro') + ':generate?key=' + encodeURIComponent(GEMINI_API_KEY);
    const body = {
      prompt: { text: prompt },
      temperature: 0.2,
      maxOutputTokens: 256
    };
    const r = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
    if(!r.ok){
      const t = await r.text();
      throw new Error('Gemini API error: ' + t);
    }
    const j = await r.json();
    // try to extract text from candidates
    const candidate = (j?.candidates && j.candidates[0] && (
      (typeof j.candidates[0].content === 'string' && j.candidates[0].content) ||
      (Array.isArray(j.candidates[0].content) && j.candidates[0].content.map(c=>c.text||'').join('')) ||
      j.candidates[0].content
    )) || JSON.stringify(j);
    // normalize if object
    if(typeof candidate === 'object') return JSON.stringify(candidate);
    return candidate;
  }

  // proxy offer click
  proxyOffer.addEventListener('click', ()=>{
    alert('æˆ‘å¯ä»¥å¹«ä½ è£½ä½œä¸€å€‹å…è²» proxyï¼ˆRender æˆ– Cloudflare Workerï¼‰ï¼ŒæŠŠé‡‘é‘°æ”¾åœ¨é‚£è£ï¼Œå‰ç«¯åªå‘¼å« proxyã€‚ä½ è¦æˆ‘å¹«å¿™ç”¢ç”Ÿ proxy ç¨‹å¼ç¢¼å—ï¼Ÿå›è¦†ã€Œå¹«æˆ‘åš proxyã€ã€‚');
  });

  deployHint.addEventListener('click', ()=>{
    alert('è¦æŠŠé€™å€‹é é¢æ”¾åˆ° GitHub Pagesï¼šå»ºç«‹ repo â†’ push æª”æ¡ˆ â†’ Settings â†’ Pages â†’ é¸ main / rootã€‚è‹¥è¦å®‰å…¨ä½¿ç”¨ Geminiï¼Œè«‹å•æˆ‘å¹«ä½ åš proxyï¼ˆæˆ‘æœƒçµ¦ä½ æ­¥é©Ÿï¼‰ã€‚');
  });

  // init render
  renderProfile();

  </script>
</body>
</html>
