<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å­¸ç¿’å°ç²¾éˆ â€” éš¨æ©Ÿ AI ç‰ˆ</title>
  <style>
    :root{
      --bg:#eeffef;
      --panel:#f6fff8;
      --accent:#3aa45e;
      --accent-hover:#2e854b;
      --muted:#5b6b5a;
      --soft:#dff7e6;
      --shadow: 0 8px 20px rgba(58,164,94,0.10);
      font-family: 'Noto Sans TC', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#133; -webkit-font-smoothing:antialiased}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:linear-gradient(90deg,#dff7e6,#eefff0);box-shadow:var(--shadow)}
    .logo{font-weight:700;font-size:18px;color:var(--accent)}
    .app{max-width:1000px;margin:18px auto;border-radius:12px;overflow:hidden;padding:12px}
    .main{display:flex;gap:16px;padding:6px;flex-wrap:wrap;}
    .sidebar{width:260px;flex-shrink:0;}
    .content{flex:1;display:flex;flex-direction:column;gap:12px;min-width:300px;}
    .panel{background:var(--panel);padding:16px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #eef7f0;}
    .avatar{font-size:44px;background:linear-gradient(90deg,#f0fff3,#e8fff0);width:76px;height:76px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 12px rgba(0,0,0,0.04);margin:0 auto 10px auto;Cursor: default;}
    .xpbar{width:80%;height:12px;background:#eef6ee;border-radius:999px;margin:8px auto;overflow:hidden;border:1px solid #dcebdc;}
    #xpFill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#7bdc93);transition:width 0.3s ease;}
    .badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;justify-content:center;}
    .badge{background:var(--soft);padding:4px 10px;border-radius:999px;font-size:12px;color:#084a20;border:1px solid #ccebd5;font-weight: bold;}
    .quests-preview{display:flex;flex-direction:column;gap:10px;margin-top:12px;}
    .quest-card{padding:12px;border-radius:10px;background:#fff;border:1px dashed #dff4dd;transition:0.2s;}
    .quest-card:hover{background:#fafffb;border-color:var(--accent);}
    .quest-type{font-weight:700;color:var(--accent);margin-bottom:4px;font-size:0.9rem;}
    
    button{background:var(--accent);color:#fff;padding:10px 16px;border-radius:8px;border:none;cursor:pointer;font-weight:600;transition:background 0.2s;font-family: inherit;}
    button:hover{background:var(--accent-hover);}
    button:disabled{background:#ccc;cursor:not-allowed;}
    button.small{padding:6px 10px;font-size:13px}
    button.secondary{background:#fff;color:var(--accent);border:1px solid #ccebd5; box-shadow: 0 2px 4px rgba(0,0,0,0.02);}
    button.secondary:hover{background:#f0fff4;}

    label{display:flex;align-items:center;margin:8px 0;padding:8px;border-radius:8px;cursor:pointer;transition:background 0.1s;border: 1px solid transparent;}
    label:hover{background:#f4fdf6; border-color: #dff7e6;}
    input[type="radio"]{margin-right:10px;accent-color:var(--accent);transform: scale(1.1);}
    
    textarea{min-height:100px;width:100%;padding:10px;border-radius:8px;border:1px solid #e6f3e8;font-family:inherit;resize: vertical;}
    input[type="text"], input[type="password"]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6f3e8;margin-bottom:8px;font-family: inherit;}
    
    .muted{color:var(--muted);font-size:14px;line-height:1.5;}
    .footer{text-align:center;padding:20px;color:var(--muted);font-size:13px;}
    
    .loader {border: 3px solid #f3f3f3;border-radius: 50%;border-top: 3px solid var(--accent);width: 16px;height: 16px;animation: spin 1s linear infinite;display:inline-block;vertical-align:middle;margin-right:8px;}
    @keyframes spin {0% { transform: rotate(0deg); }100% { transform: rotate(360deg); }}
    .error-msg {color:#d32f2f;background:#ffebee;padding:10px;border-radius:8px;margin-top:8px;font-size:13px;display:none;border: 1px solid #f5c6cb;}

    @media(max-width: 600px){
      .sidebar{width:100%;}
      .main{flex-direction:column;}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="logo">ğŸŒ¿ å­¸ç¿’å°ç²¾éˆ (AI éš¨æ©Ÿç‰ˆ)</div>
    <button class="small secondary" onclick="alert('æœ¬ç¶²é ç´”å‰ç«¯åŸ·è¡Œï¼Œæ‚¨çš„ API Key èˆ‡éŠæˆ²é€²åº¦åƒ…å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ localStorageã€‚')">å®‰å…¨è²æ˜</button>
  </div>

  <div class="app">
    <div class="main">
      <aside class="sidebar">
        <div class="panel" style="text-align:center">
          <div class="avatar">ğŸ¦‹</div>
          <h3 id="playerName" style="margin:5px 0">å†’éšªè€…</h3>
          <div style="color:var(--accent);font-weight:bold;">Lv <span id="level">1</span></div>
          <div class="xpbar"><div id="xpFill"></div></div>
          <p style="font-size:12px;color:var(--muted)">XP: <span id="currentXp">0</span> / 200</p>
          <button class="small secondary" style="width:100%; margin-top:5px;" onclick="resetGame()">é‡è¨­é€²åº¦</button>
        </div>

        <div class="panel">
          <h4 style="margin-top:0">æˆå°±å¾½ç« </h4>
          <div id="badges" class="badges">
            <span style="font-size:12px;color:#aaa">å°šæœªç²å¾—å¾½ç« </span>
          </div>
        </div>
      </aside>

      <section class="content">
        <div class="panel" id="configPanel">
          <h4 style="margin-top:0">âš™ï¸ AI è¨­å®š</h4>
          <p class="muted" style="margin-bottom:8px">è¼¸å…¥ Gemini API Key ä»¥å•Ÿç”¨ AI å‡ºé¡Œï¼š</p>
          <div style="display:flex;gap:8px;">
            <input type="password" id="apiKeyInput" placeholder="AIza..." />
            <button id="saveKeyBtn" class="small">å„²å­˜</button>
          </div>
        </div>

        <div class="panel" id="dashboardPanel">
          <h3 style="margin-top:0">ä»Šæ—¥ä»»å‹™</h3>
          <p class="muted">æŒ‘æˆ°éš¨æ©Ÿç”Ÿæˆçš„é¡Œç›®ä¾†ç²å–ç¶“é©—å€¼ï¼</p>

          <div id="questsPreview" class="quests-preview">
            <div style="text-align:center;padding:20px;color:#aaa;border:2px dashed #eee;border-radius:10px;">
              å°šæœªç”Ÿæˆä»»å‹™
            </div>
          </div>
          
          <div id="errorBox" class="error-msg"></div>

          <div style="display:flex;gap:12px;margin-top:20px;flex-wrap: wrap;">
            <button id="fetchGeminiBtn">âœ¨ AI éš¨æ©Ÿä»»å‹™</button>
            <button id="startMockBtn" class="secondary">ğŸ“´ é›¢ç·šç¯„ä¾‹é¡Œç›®</button>
          </div>
        </div>

        <div class="panel" id="questPanel" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
             <h3 id="questTitle" style="margin:0">ä»»å‹™</h3>
             <button id="backBtn" class="secondary small">è¿”å›</button>
          </div>
          <div id="questArea"></div>
          <div style="margin-top:20px;text-align:right;border-top:1px solid #eee;padding-top:15px; min-height: 60px;">
            <div id="feedbackArea" style="float:left;font-weight:bold; line-height: 38px;"></div>
            <button id="submitBtn">æäº¤ç­”æ¡ˆ</button>
            <button id="nextQuestBtn" style="display:none">ä¸‹ä¸€é¡Œ â†’</button>
          </div>
        </div>
      </section>
    </div>
    <div class="footer">Â© å­¸ç¿’å°ç²¾éˆ â€” Gemini AI Powered</div>
  </div>

  <script>
  /****************************************************************
   * 1. åˆå§‹åŒ–èˆ‡ç‹€æ…‹ç®¡ç†
   ****************************************************************/
  let state = { xp: 0, level: 1, badges: [] };
  let quests = [];
  let currentIndex = 0;
  
  // è¼‰å…¥å­˜æª”
  function loadState() {
    const saved = localStorage.getItem('ELF_GAME_STATE');
    if (saved) {
      state = JSON.parse(saved);
    }
    const key = localStorage.getItem('GEMINI_API_KEY');
    if (key) {
      document.getElementById('apiKeyInput').value = key;
    }
  }

  function saveState() {
    localStorage.setItem('ELF_GAME_STATE', JSON.stringify(state));
  }

  function resetGame() {
    if(confirm('ç¢ºå®šè¦é‡è¨­æ‰€æœ‰ç­‰ç´šã€ç¶“é©—å€¼èˆ‡å¾½ç« å—ï¼Ÿ')){
      state = { xp: 0, level: 1, badges: [] };
      saveState();
      renderProfile();
    }
  }

  const els = {
    apiKeyInput: document.getElementById('apiKeyInput'),
    saveKeyBtn: document.getElementById('saveKeyBtn'),
    fetchGeminiBtn: document.getElementById('fetchGeminiBtn'),
    startMockBtn: document.getElementById('startMockBtn'),
    questsPreview: document.getElementById('questsPreview'),
    dashboardPanel: document.getElementById('dashboardPanel'),
    questPanel: document.getElementById('questPanel'),
    questTitle: document.getElementById('questTitle'),
    questArea: document.getElementById('questArea'),
    backBtn: document.getElementById('backBtn'),
    submitBtn: document.getElementById('submitBtn'),
    nextQuestBtn: document.getElementById('nextQuestBtn'),
    feedbackArea: document.getElementById('feedbackArea'),
    errorBox: document.getElementById('errorBox'),
    xpFill: document.getElementById('xpFill'),
    currentXp: document.getElementById('currentXp'),
    level: document.getElementById('level'),
    badges: document.getElementById('badges')
  };

  /****************************************************************
   * 2. æ ¸å¿ƒé‚è¼¯ï¼šé›¢ç·šé¡Œåº«
   ****************************************************************/
  els.startMockBtn.addEventListener('click', () => {
    const mockPool = {
      english: [
        { question: 'Which word means "å‹‡æ•¢çš„"?', choices: ['Brave', 'Coy', 'Lazy', 'Bitter'], answer: 0 },
        { question: 'Choose the opposite of "Huge":', choices: ['Giant', 'Tiny', 'Wide', 'Heavy'], answer: 1 },
        { question: '"Artificial Intelligence" çš„ä¸­æ–‡æ˜¯ï¼Ÿ', choices: ['æ“´å¢å¯¦å¢ƒ', 'è™›æ“¬è²¨å¹£', 'äººå·¥æ™ºæ…§', 'æ©Ÿå™¨å­¸ç¿’'], answer: 2 },
        { question: 'Which word is a fruit?', choices: ['Carrot', 'Apple', 'Broccoli', 'Onion'], answer: 1 }
      ],
      coding: [
        { question: 'JS ä¸­å®£å‘Šå¸¸æ•¸çš„é—œéµå­—æ˜¯ï¼Ÿ', choices: ['var', 'let', 'const', 'define'], answer: 2 },
        { question: 'HTML ä¸­å»ºç«‹è¶…é€£çµçš„æ¨™ç±¤æ˜¯ï¼Ÿ', choices: ['<link>', '<a>', '<href>', '<nav>'], answer: 1 },
        { question: 'CSS ä¸­å“ªå€‹å±¬æ€§æ§åˆ¶æ–‡å­—é¡è‰²ï¼Ÿ', choices: ['text-style', 'font-color', 'color', 'background-color'], answer: 2 }
      ],
      general: [
        { question: 'å¤ªé™½ç³»ä¸­é«”ç©æœ€å¤§çš„è¡Œæ˜Ÿæ˜¯ï¼Ÿ', choices: ['åœ°çƒ', 'ç«æ˜Ÿ', 'æœ¨æ˜Ÿ', 'åœŸæ˜Ÿ'], answer: 2 },
        { question: 'æ°´çš„åŒ–å­¸åˆ†å­å¼æ˜¯ï¼Ÿ', choices: ['CO2', 'H2O', 'O2', 'NaCl'], answer: 1 },
        { question: 'ä¸€å¹´ç•¶ä¸­æœ‰å¹¾å€‹æœˆæœ‰ 31 å¤©ï¼Ÿ', choices: ['5å€‹', '6å€‹', '7å€‹', '8å€‹'], answer: 2 }
      ]
    };

    const getRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];
    
    quests = [
      { type: 'è‹±æ–‡æŒ‘æˆ° (é›¢ç·š)', payload: getRandom(mockPool.english) },
      { type: 'ç¨‹å¼é‚è¼¯ (é›¢ç·š)', payload: getRandom(mockPool.coding) },
      { type: 'çŸ¥è­˜ç™¾ç§‘ (é›¢ç·š)', payload: getRandom(mockPool.general) }
    ];

    renderQuestsPreview();
    alert('å·²è¼‰å…¥éš¨æ©Ÿé›¢ç·šé¡Œç›®ï¼');
  });

  /****************************************************************
   * 3. AI åŠŸèƒ½ï¼šGemini API
   ****************************************************************/
  els.saveKeyBtn.addEventListener('click', () => {
    const key = els.apiKeyInput.value.trim();
    if(key.startsWith('AIza')) {
      localStorage.setItem('GEMINI_API_KEY', key);
      alert('API Key å·²å„²å­˜ï¼');
    } else {
      alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ API Key');
    }
  });

  els.fetchGeminiBtn.addEventListener('click', async () => {
    const key = localStorage.getItem('GEMINI_API_KEY');
    if(!key){ alert('è«‹å…ˆè¨­å®š API Key'); return; }
    
    setLoading(true);
    els.errorBox.style.display = 'none';

    try {
      const topic = ['æ—…è¡Œ', 'ç§‘æŠ€', 'ç¾é£Ÿ', 'å¤ªç©º', 'è‡ªç„¶'][Math.floor(Math.random()*5)];
      const prompt = `Generate 2 multiple-choice questions in Traditional Chinese. 
      One about English vocabulary for "${topic}", one about general knowledge.
      Return ONLY a JSON array: [{"type":"Category", "question":"...", "choices":["A","B","C","D"], "answer":0}]`;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });

      if(!response.ok) throw new Error("API è«‹æ±‚å¤±æ•—");
      const data = await response.json();
      const rawText = data.candidates[0].content.parts[0].text;
      const cleanText = rawText.replace(/```json|```/g, '').trim();
      const aiQuests = JSON.parse(cleanText);

      quests = aiQuests.map(q => ({ type: q.type, payload: q }));
      quests.push({ type: 'AI æŒ‘æˆ°', payload: { question: `èªªèªªçœ‹ï¼Œ"${topic}" å°ä½ è€Œè¨€ä»£è¡¨ä»€éº¼æ„ç¾©ï¼Ÿ` } });
      
      renderQuestsPreview();
    } catch(err) {
      els.errorBox.textContent = "AI ç”Ÿæˆå¤±æ•—: " + err.message;
      els.errorBox.style.display = 'block';
    } finally {
      setLoading(false);
    }
  });

  function setLoading(isLoading) {
    els.fetchGeminiBtn.innerHTML = isLoading ? '<span class="loader"></span> ç”Ÿæˆä¸­...' : 'âœ¨ AI éš¨æ©Ÿä»»å‹™';
    els.fetchGeminiBtn.disabled = isLoading;
  }

  /****************************************************************
   * 4. éŠæˆ²äº’å‹•é‚è¼¯
   ****************************************************************/
  function renderQuestsPreview(){
    els.questsPreview.innerHTML = '';
    quests.forEach((q, i) => {
      const card = document.createElement('div'); 
      card.className = 'quest-card';
      card.innerHTML = `
        <div class="quest-type">${q.type}</div>
        <div style="font-size:14px; color:#555;">${q.payload.question}</div>
        <button class="small" style="margin-top:8px" onclick="startQuest(${i})">é–‹å§‹æŒ‘æˆ°</button>
      `;
      els.questsPreview.appendChild(card);
    });
  }

  window.startQuest = function(index) {
    currentIndex = index;
    const q = quests[index];
    els.dashboardPanel.style.display = 'none';
    els.questPanel.style.display = 'block';
    els.questTitle.textContent = q.type;
    els.submitBtn.style.display = 'inline-block';
    els.nextQuestBtn.style.display = 'none';
    els.feedbackArea.textContent = '';
    els.questArea.innerHTML = `<p style="font-size:1.1rem;font-weight:500">${q.payload.question}</p>`;
    
    if (q.payload.choices) {
      q.payload.choices.forEach((c, i) => {
        const label = document.createElement('label');
        label.innerHTML = `<input type="radio" name="choice" value="${i}"> ${c}`;
        els.questArea.appendChild(label);
      });
    } else {
      els.questArea.innerHTML += `<textarea id="freeTextAns" placeholder="è«‹åœ¨æ­¤è¼¸å…¥ä½ çš„å›ç­”..."></textarea>`;
    }
  };

  els.submitBtn.addEventListener('click', () => {
    const q = quests[currentIndex];
    let isCorrect = false;

    if (q.payload.choices) {
      const sel = document.querySelector('input[name="choice"]:checked');
      if (!sel) return alert('è«‹å…ˆé¸æ“‡ç­”æ¡ˆï¼');
      isCorrect = parseInt(sel.value) === q.payload.answer;
    } else {
      if(!document.getElementById('freeTextAns').value.trim()) return alert('è«‹è¼¸å…¥å…§å®¹');
      isCorrect = true; 
    }

    if (isCorrect) {
      els.feedbackArea.textContent = 'ğŸ‰ ç­”å°äº†ï¼ +50 XP';
      els.feedbackArea.style.color = 'var(--accent)';
      addXp(50);
    } else {
      const correctText = q.payload.choices[q.payload.answer];
      els.feedbackArea.textContent = `âŒ ç­”éŒ¯äº†ã€‚æ­£ç¢ºç­”æ¡ˆï¼š${correctText}`;
      els.feedbackArea.style.color = '#d32f2f';
      addXp(10);
    }

    els.submitBtn.style.display = 'none';
    if(currentIndex < quests.length - 1) {
      els.nextQuestBtn.style.display = 'inline-block';
    } else {
      const btn = document.createElement('button');
      btn.textContent = 'å®Œæˆä»Šæ—¥è¨“ç·´';
      btn.className = 'small';
      btn.onclick = () => { 
        els.questPanel.style.display='none'; 
        els.dashboardPanel.style.display='block';
        els.questsPreview.innerHTML = '<div style="text-align:center;padding:20px;color:var(--accent);font-weight:bold;">âœ¨ ä»»å‹™å®Œæˆï¼æ˜å¤©å†ä¾†å§ï¼</div>';
      };
      els.feedbackArea.appendChild(btn);
    }
  });

  els.nextQuestBtn.addEventListener('click', () => startQuest(currentIndex + 1));
  els.backBtn.addEventListener('click', () => {
    els.questPanel.style.display = 'none';
    els.dashboardPanel.style.display = 'block';
  });

  function addXp(amount) {
    state.xp += amount;
    if (state.xp >= 200) {
      state.level++;
      state.xp -= 200;
      if (!state.badges.includes('é–‹æ‹“è€…')) state.badges.push('é–‹æ‹“è€…');
      alert(`æ­å–œå‡ç´šï¼Lv ${state.level}`);
    }
    saveState();
    renderProfile();
  }

  function renderProfile() {
    els.xpFill.style.width = Math.min(100, (state.xp / 200) * 100) + '%';
    els.currentXp.textContent = state.xp;
    els.level.textContent = state.level;
    if (state.badges.length > 0) {
      els.badges.innerHTML = '';
      state.badges.forEach(b => {
        const span = document.createElement('span');
        span.className = 'badge';
        span.textContent = b;
        els.badges.appendChild(span);
      });
    }
  }

  // ç¨‹å¼å•Ÿå‹•
  loadState();
  renderProfile();

  </script>
</body>
</html>
