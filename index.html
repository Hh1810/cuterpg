<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å­¸ç¿’å°ç²¾éˆ â€” éš¨æ©Ÿ AI ç‰ˆ</title>
  <style>
    /* ç¶ è‰²ä¸»é¡Œã€ç°¡æ½”å®‰å…¨ç‰ˆ */
    :root{
      --bg:#eeffef;
      --panel:#f6fff8;
      --accent:#3aa45e;
      --accent-hover:#2e854b;
      --muted:#5b6b5a;
      --soft:#dff7e6;
      --shadow: 0 8px 20px rgba(58,164,94,0.10);
      font-family: 'Noto Sans TC', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#133; -webkit-font-smoothing:antialiased}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:linear-gradient(90deg,#dff7e6,#eefff0);box-shadow:var(--shadow)}
    .logo{font-weight:700;font-size:18px;color:var(--accent)}
    .app{max-width:1000px;margin:18px auto;border-radius:12px;overflow:hidden;padding:12px}
    .main{display:flex;gap:16px;padding:6px;flex-wrap:wrap;}
    .sidebar{width:260px;flex-shrink:0;}
    .content{flex:1;display:flex;flex-direction:column;gap:12px;min-width:300px;}
    .panel{background:var(--panel);padding:16px;border-radius:12px;box-shadow:var(--shadow);border:1px solid #eef7f0;}
    .avatar{font-size:44px;background:linear-gradient(90deg,#f0fff3,#e8fff0);width:76px;height:76px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 12px rgba(0,0,0,0.04);margin:0 auto 10px auto;}
    .xpbar{width:80%;height:12px;background:#eef6ee;border-radius:999px;margin:8px auto;overflow:hidden;border:1px solid #dcebdc;}
    #xpFill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#7bdc93);transition:width 0.3s ease;}
    .badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;justify-content:center;}
    .badge{background:var(--soft);padding:4px 10px;border-radius:999px;font-size:12px;color:#084a20;border:1px solid #ccebd5;}
    .quests-preview{display:flex;flex-direction:column;gap:10px;margin-top:12px;}
    .quest-card{padding:12px;border-radius:10px;background:#fff;border:1px dashed #dff4dd;transition:0.2s;}
    .quest-card:hover{background:#fafffb;border-color:var(--accent);}
    .quest-type{font-weight:700;color:var(--accent);margin-bottom:4px;font-size:0.9rem;}
    
    button{background:var(--accent);color:#fff;padding:10px 16px;border-radius:8px;border:none;cursor:pointer;font-weight:600;transition:background 0.2s;}
    button:hover{background:var(--accent-hover);}
    button:disabled{background:#ccc;cursor:not-allowed;}
    button.small{padding:6px 10px;font-size:13px}
    button.secondary{background:#fff;color:var(--accent);border:1px solid #ccebd5;}
    button.secondary:hover{background:#f0fff4;}

    label{display:flex;align-items:center;margin:8px 0;padding:8px;border-radius:8px;cursor:pointer;transition:background 0.1s;}
    label:hover{background:#f4fdf6;}
    input[type="radio"]{margin-right:10px;accent-color:var(--accent);}
    
    textarea{min-height:100px;width:100%;padding:10px;border-radius:8px;border:1px solid #e6f3e8;font-family:inherit;}
    input[type="text"], input[type="password"]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6f3e8;margin-bottom:8px;}
    
    .muted{color:var(--muted);font-size:14px;line-height:1.5;}
    .footer{text-align:center;padding:20px;color:var(--muted);font-size:13px;}
    
    /* Loading Spinner */
    .loader {border: 3px solid #f3f3f3;border-radius: 50%;border-top: 3px solid var(--accent);width: 20px;height: 20px;-webkit-animation: spin 1s linear infinite;animation: spin 1s linear infinite;display:inline-block;vertical-align:middle;margin-right:8px;}
    @keyframes spin {0% { transform: rotate(0deg); }100% { transform: rotate(360deg); }}
    .hidden {display:none;}
    .error-msg {color:#d32f2f;background:#ffebee;padding:10px;border-radius:8px;margin-top:8px;font-size:13px;display:none;}

    @media(max-width: 600px){
      .sidebar{width:100%;}
      .main{flex-direction:column;}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="logo">ğŸŒ¿ å­¸ç¿’å°ç²¾éˆ (AI éš¨æ©Ÿç‰ˆ)</div>
    <button class="small secondary" onclick="alert('æœ¬ç¶²é ç´”å‰ç«¯åŸ·è¡Œï¼Œæ‚¨çš„ API Key åƒ…å„²å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ localStorageï¼Œä¸æœƒå‚³é€åˆ°ä»»ä½•å¾Œç«¯ä¼ºæœå™¨ã€‚')">å®‰å…¨è²æ˜</button>
  </div>

  <div class="app">
    <div class="main">
      <aside class="sidebar">
        <div class="panel" style="text-align:center">
          <div class="avatar">ğŸ¦‹</div>
          <h3 id="playerName" style="margin:5px 0">å†’éšªè€…</h3>
          <div style="color:var(--accent);font-weight:bold;">Lv <span id="level">1</span></div>
          <div class="xpbar"><div id="xpFill"></div></div>
          <p style="font-size:12px;color:var(--muted)">XP: <span id="currentXp">0</span> / 200</p>
        </div>

        <div class="panel">
          <h4 style="margin-top:0">æˆå°±å¾½ç« </h4>
          <div id="badges" class="badges">
            <span style="font-size:12px;color:#aaa">å°šæœªç²å¾—å¾½ç« </span>
          </div>
        </div>
      </aside>

      <section class="content">
        
        <div class="panel" id="configPanel">
          <h4 style="margin-top:0">âš™ï¸ AI è¨­å®š</h4>
          <p class="muted" style="margin-bottom:8px">è«‹è¼¸å…¥ Google Gemini API Key ä»¥å•Ÿç”¨ AI å‡ºé¡ŒåŠŸèƒ½ï¼š</p>
          <div style="display:flex;gap:8px;">
            <input type="password" id="apiKeyInput" placeholder="è²¼ä¸Šä½ çš„ API Key (ä»¥ AIza é–‹é ­...)" />
            <button id="saveKeyBtn" class="small">å„²å­˜</button>
          </div>
          <p style="font-size:12px;color:#888;margin:4px 0;">* Key æœƒè‡ªå‹•å­˜åœ¨ç€è¦½å™¨ï¼Œä¸‹æ¬¡ä¸ç”¨é‡è¼¸ã€‚</p>
        </div>

        <div class="panel" id="dashboardPanel">
          <h3 style="margin-top:0">ä»Šæ—¥ä»»å‹™</h3>
          <p class="muted">é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼ŒAI å°‡éš¨æ©Ÿç”Ÿæˆå…¨æ–°é¡Œç›®ã€‚</p>

          <div id="questsPreview" class="quests-preview">
            <div style="text-align:center;padding:20px;color:#aaa;border:2px dashed #eee;border-radius:10px;">
              å°šæœªç”Ÿæˆä»»å‹™
            </div>
          </div>
          
          <div id="errorBox" class="error-msg"></div>

          <div style="display:flex;gap:12px;margin-top:20px">
            <button id="fetchGeminiBtn">âœ¨ ç”Ÿæˆéš¨æ©Ÿ AI ä»»å‹™</button>
            <button id="startMockBtn" class="secondary">ä½¿ç”¨é›¢ç·šç¯„ä¾‹ (ç„¡ AI)</button>
          </div>
        </div>

        <div class="panel" id="questPanel" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
             <h3 id="questTitle" style="margin:0">ä»»å‹™</h3>
             <button id="backBtn" class="secondary small">æ”¾æ£„è¿”å›</button>
          </div>
         
          <div id="questArea"></div>
          
          <div style="margin-top:20px;text-align:right;border-top:1px solid #eee;padding-top:15px;">
            <div id="feedbackArea" style="float:left;font-weight:bold;"></div>
            <button id="submitBtn">æäº¤ç­”æ¡ˆ</button>
            <button id="nextQuestBtn" style="display:none">ä¸‹ä¸€é¡Œ â†’</button>
          </div>
        </div>

      </section>
    </div>

    <div class="footer">Â© å­¸ç¿’å°ç²¾éˆ â€” Gemini AI Powered</div>
  </div>

  <script>
  /****************************************************************
   * æ ¸å¿ƒé‚è¼¯
   ****************************************************************/
  
  // 1. ç‹€æ…‹ç®¡ç†
  const state = { xp: 0, level: 1, badges: [] };
  let quests = [];
  let currentIndex = 0;
  
  // 2. å˜—è©¦å¾ LocalStorage è®€å– Key
  let GEMINI_API_KEY = localStorage.getItem('AIzaSyA1qz0SSfgtykSctZ35rhLI1IesiSxN4UQ') || '';
  const GEMINI_MODEL = 'gemini-1.5-flash'; // Flash æ¯”è¼ƒå¿«ä¸”ä¾¿å®œï¼Œé©åˆé€™ç¨®æ‡‰ç”¨

  // DOM å…ƒç´ å¼•ç”¨
  const els = {
    apiKeyInput: document.getElementById('apiKeyInput'),
    saveKeyBtn: document.getElementById('saveKeyBtn'),
    fetchGeminiBtn: document.getElementById('fetchGeminiBtn'),
    startMockBtn: document.getElementById('startMockBtn'),
    questsPreview: document.getElementById('questsPreview'),
    dashboardPanel: document.getElementById('dashboardPanel'),
    questPanel: document.getElementById('questPanel'),
    questTitle: document.getElementById('questTitle'),
    questArea: document.getElementById('questArea'),
    backBtn: document.getElementById('backBtn'),
    submitBtn: document.getElementById('submitBtn'),
    nextQuestBtn: document.getElementById('nextQuestBtn'),
    feedbackArea: document.getElementById('feedbackArea'),
    errorBox: document.getElementById('errorBox'),
    xpFill: document.getElementById('xpFill'),
    currentXp: document.getElementById('currentXp'),
    level: document.getElementById('level'),
    badges: document.getElementById('badges')
  };

  // åˆå§‹åŒ– UI
  if(GEMINI_API_KEY) els.apiKeyInput.value = GEMINI_API_KEY;
  renderProfile();

  // --- äº‹ä»¶ç›£è½ ---

  // å„²å­˜ Key
  els.saveKeyBtn.addEventListener('click', () => {
    const key = els.apiKeyInput.value.trim();
    if(key) {
      localStorage.setItem('GEMINI_API_KEY', key);
      GEMINI_API_KEY = key;
      alert('API Key å·²å„²å­˜ï¼ç¾åœ¨å¯ä»¥æŒ‰ã€Œç”Ÿæˆéš¨æ©Ÿ AI ä»»å‹™ã€äº†ã€‚');
    }
  });

  // é›¢ç·š Mock æ¨¡å¼
  els.startMockBtn.addEventListener('click', () => {
    quests = [
      { type:'è‹±æ–‡', payload:{ question:'Which word means "å‹å–„"?', choices:['hostile','friendly','sad','tall'], answer:1 }},
      { type:'ç¨‹å¼', payload:{ question:'JavaScript ä¸­ç”¨ä¾†è¼¸å‡ºè¨Šæ¯åˆ°æ§åˆ¶å°çš„æ˜¯?', choices:['console.log','print','echo','out'], answer:0 }},
    ];
    renderQuestsPreview();
  });

  // AI æ¨¡å¼ (é‡é»ä¿®æ”¹è™•)
  els.fetchGeminiBtn.addEventListener('click', async () => {
    if(!GEMINI_API_KEY){
      alert('è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥æ¡†å¡«å…¥ Gemini API Key æ‰èƒ½ä½¿ç”¨ AI ç”ŸæˆåŠŸèƒ½ã€‚');
      return;
    }
    
    // UI é€²å…¥ Loading ç‹€æ…‹
    setLoading(true);
    els.errorBox.style.display = 'none';

    try {
      quests = await generateRandomQuests();
      renderQuestsPreview();
    } catch(err) {
      console.error(err);
      els.errorBox.textContent = `ç”Ÿæˆå¤±æ•—: ${err.message}`;
      els.errorBox.style.display = 'block';
    } finally {
      setLoading(false);
    }
  });

  // --- AI æ ¸å¿ƒåŠŸèƒ½ ---

  async function generateRandomQuests() {
    // éš¨æ©Ÿä¸»é¡Œåˆ—è¡¨ï¼Œè®“æ¯æ¬¡å–®å­—éƒ½ä¸ä¸€æ¨£
    const topics = ['æ—…è¡Œ', 'é£Ÿç‰©', 'ç§‘æŠ€', 'å•†æ¥­', 'æƒ…æ„Ÿ', 'è‡ªç„¶', 'å¥åº·', 'é‹å‹•', 'è—è¡“'];
    const randomTopic = topics[Math.floor(Math.random() * topics.length)];
    
    // æˆ‘å€‘åŒæ™‚ç™¼é€å¤šå€‹è«‹æ±‚ï¼Œæˆ–è€…ä¸€å€‹è«‹æ±‚è¦å¤šé¡Œã€‚é€™è£¡ç¤ºç¯„åˆ†é–‹ Prompt æ¯”è¼ƒå¥½æ§åˆ¶ã€‚
    // ä½¿ç”¨ Promise.all å¹³è¡Œè™•ç†åŠ é€Ÿ
    const prompt1 = `Generate 1 multiple-choice question for English vocabulary learning. 
    Topic: "${randomTopic}". Difficulty: Beginner/Intermediate.
    Format: JSON object with keys: "question", "choices" (array of 4 strings), "answer" (index 0-3).
    Do NOT use markdown formatting. Just raw JSON.`;

    const prompt2 = `Generate 1 JavaScript or Python coding concept multiple-choice question.
    Topic: Random basic concept (Variables, Loops, Functions, Arrays).
    Format: JSON object with keys: "question", "choices" (array of 4 strings), "answer" (index 0-3).
    Do NOT use markdown formatting. Just raw JSON.`;

    const [res1, res2] = await Promise.all([
      callGeminiAPI(prompt1),
      callGeminiAPI(prompt2)
    ]);

    // åŠ ä¸Šä¸€å€‹ç°¡å–®çš„å•ç­”é¡Œ
    const quest3 = {
        type: 'AI æŒ‘æˆ°',
        payload: { question: `è«‹ç”¨ä¸€å¥è©±å½¢å®¹"${randomTopic}"å°ä½ çš„æ„ç¾© (è‡ªç”±å›ç­”)` }
    };

    return [
      { type: `è‹±æ–‡ (${randomTopic})`, payload: parseGeminiResponse(res1) },
      { type: 'ç¨‹å¼é‚è¼¯', payload: parseGeminiResponse(res2) },
      quest3
    ];
  }

  async function callGeminiAPI(promptText) {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
    
    const body = {
      contents: [{
        parts: [{ text: promptText }]
      }]
    };

    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (!response.ok) {
      const errText = await response.text();
      throw new Error(`Gemini API Error: ${response.status} - ${errText}`);
    }

    const data = await response.json();
    // å–å‡ºæ–‡å­—å…§å®¹
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!text) throw new Error("API å›å‚³æ ¼å¼ä¸å¦‚é æœŸ");
    return text;
  }

  // æ¸…æ´—ä¸¦è§£æ JSON (é‡è¦ï¼è§£æ±º AI å›å‚³ markdown çš„å•é¡Œ)
  function parseGeminiResponse(text) {
    try {
      // ç§»é™¤ ```json å’Œ ``` 
      let cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
      return JSON.parse(cleanText);
    } catch (e) {
      console.warn("JSON Parse Error, fallback to text", text);
      // è¬ä¸€è§£æå¤±æ•—ï¼Œå›å‚³ä¸€å€‹éŒ¯èª¤é¡Œï¼Œé¿å…ç¨‹å¼ç•¶æ‰
      return {
        question: "AI è§£ææ ¼å¼éŒ¯èª¤ï¼ŒåŸå§‹å…§å®¹: " + text.substring(0, 50) + "...",
        choices: ["éŒ¯èª¤", "éŒ¯èª¤", "éŒ¯èª¤", "éŒ¯èª¤"],
        answer: 0
      };
    }
  }

  // --- UI æ¸²æŸ“é‚è¼¯ ---

  function setLoading(isLoading) {
    if(isLoading) {
      els.fetchGeminiBtn.innerHTML = '<span class="loader"></span> ç”Ÿæˆä¸­...';
      els.fetchGeminiBtn.disabled = true;
    } else {
      els.fetchGeminiBtn.innerHTML = 'âœ¨ ç”Ÿæˆéš¨æ©Ÿ AI ä»»å‹™';
      els.fetchGeminiBtn.disabled = false;
    }
  }

  function renderQuestsPreview(){
    els.questsPreview.innerHTML = '';
    quests.forEach((q, i) => {
      const card = document.createElement('div'); 
      card.className = 'quest-card';
      card.innerHTML = `
        <div class="quest-type">${q.type}</div>
        <div style="font-size:14px">${q.payload.question}</div>
        <button class="small" style="margin-top:8px" onclick="startQuest(${i})">é–‹å§‹æŒ‘æˆ°</button>
      `;
      els.questsPreview.appendChild(card);
    });
    els.dashboardPanel.style.display = 'block';
    els.questPanel.style.display = 'none';
  }

  window.startQuest = function(index) {
    currentIndex = index;
    const q = quests[index];
    els.dashboardPanel.style.display = 'none';
    els.questPanel.style.display = 'block';
    els.questTitle.textContent = q.type;
    
    // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
    els.submitBtn.style.display = 'inline-block';
    els.nextQuestBtn.style.display = 'none';
    els.feedbackArea.textContent = '';
    els.feedbackArea.className = '';

    els.questArea.innerHTML = `<p style="font-size:1.1rem;font-weight:500">${q.payload.question}</p>`;
    
    if (q.payload.choices) {
      // é¸æ“‡é¡Œ
      q.payload.choices.forEach((c, i) => {
        const label = document.createElement('label');
        label.innerHTML = `<input type="radio" name="choice" value="${i}"> ${c}`;
        els.questArea.appendChild(label);
      });
    } else {
      // ç°¡ç­”é¡Œ
      const ta = document.createElement('textarea');
      ta.id = "freeTextAns";
      ta.placeholder = 'è«‹è¼¸å…¥ä½ çš„æƒ³æ³•...';
      els.questArea.appendChild(ta);
    }
  };

  els.backBtn.addEventListener('click', () => {
    els.questPanel.style.display = 'none';
    els.dashboardPanel.style.display = 'block';
  });

  els.submitBtn.addEventListener('click', () => {
    const q = quests[currentIndex];
    let isCorrect = false;
    let userAns = null;

    if (q.payload.choices) {
      const sel = document.querySelector('input[name="choice"]:checked');
      if (!sel) {
        alert('è«‹å…ˆé¸æ“‡ä¸€å€‹ç­”æ¡ˆï¼');
        return;
      }
      userAns = parseInt(sel.value);
      isCorrect = (userAns === q.payload.answer);
    } else {
      // è‡ªç”±ç°¡ç­”é¡Œéƒ½ç®—å°
      const text = document.getElementById('freeTextAns').value;
      if(!text.trim()) { alert('è«‹è¼¸å…¥å…§å®¹'); return; }
      isCorrect = true; 
    }

    if (isCorrect) {
      els.feedbackArea.textContent = 'ğŸ‰ ç­”å°äº†ï¼ +50 XP';
      els.feedbackArea.style.color = 'var(--accent)';
      addXp(50);
    } else {
      els.feedbackArea.textContent = `âŒ ç­”éŒ¯äº†ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯: ${q.payload.choices[q.payload.answer]}`;
      els.feedbackArea.style.color = '#d32f2f';
      addXp(10); // å®‰æ…°ç
    }

    els.submitBtn.style.display = 'none';
    if(currentIndex < quests.length - 1) {
      els.nextQuestBtn.style.display = 'inline-block';
    } else {
      // æœ€å¾Œä¸€é¡Œ
      const finishBtn = document.createElement('button');
      finishBtn.textContent = 'å®Œæˆä»Šæ—¥è¨“ç·´';
      finishBtn.onclick = () => { els.questPanel.style.display='none'; els.dashboardPanel.style.display='block'; };
      els.feedbackArea.parentNode.appendChild(finishBtn);
    }
  });

  els.nextQuestBtn.addEventListener('click', () => {
    startQuest(currentIndex + 1);
  });

  function addXp(amount) {
    state.xp += amount;
    if (state.xp >= 200) {
      state.level++;
      state.xp -= 200;
      if (!state.badges.includes('Lv Up!')) state.badges.push('Lv Up!');
      alert(`æ­å–œå‡ç´šï¼ç¾åœ¨æ˜¯ Lv ${state.level}`);
    }
    renderProfile();
  }

  function renderProfile() {
    els.xpFill.style.width = Math.min(100, (state.xp / 200) * 100) + '%';
    els.currentXp.textContent = state.xp;
    els.level.textContent = state.level;
    
    if (state.badges.length > 0) {
      els.badges.innerHTML = '';
      state.badges.forEach(b => {
        const span = document.createElement('span');
        span.className = 'badge';
        span.textContent = b;
        els.badges.appendChild(span);
      });
    }
  }

  </script>
</body>
</html>
